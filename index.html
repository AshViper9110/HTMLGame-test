<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>movetest</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="controls">
      <button
        class="btn up"
        onpointerdown="keys.w=true"
        onpointerup="keys.w=false"
        ontouchcancel="keys.w=false"
        ontouchend="keys.w=false"
      >
        ‚Üë
      </button>
      <button
        class="btn left"
        onpointerdown="keys.a=true"
        onpointerup="keys.a=false"
        ontouchcancel="keys.a=false"
        ontouchend="keys.a=false"
      >
        ‚Üê
      </button>
      <button
        class="btn down"
        onpointerdown="keys.s=true"
        onpointerup="keys.s=false"
        ontouchcancel="keys.s=false"
        ontouchend="keys.s=false"
      >
        ‚Üì
      </button>
      <button
        class="btn right"
        onpointerdown="keys.d=true"
        onpointerup="keys.d=false"
        ontouchcancel="keys.d=false"
        ontouchend="keys.d=false"
      >
        ‚Üí
      </button>
    </div>
    <div id="gameContainer">
      <div class="moveEria">
        <p id="UIText"></p>
        <input type="button" class="itemList" value="„Éê„Çø„Çπ„Ç≥" />
        <input type="button" class="itemList" value="Â§¢" />
      </div>
      <div class="player" id="player"></div>
      <input type="button" class="action" value="‚öîAttack" />
      <input type="button" class="action" value="üì∂action" />
      <input type="button" class="action" value="üõçitem" />
      <input type="button" class="action" value="‚úñmercy" />
      <p class="UI" id="name">Name</p>
      <p class="UI" id="level">LV 1</p>
      <p class="UI" id="hpLabel">HP</p>
      <div class="hpbar" id="hpbarback"></div>
      <div class="hpbar" id="hpbar"></div>
      <div class="bosshpbar" id="bosshpbarback"></div>
      <div class="bosshpbar" id="bosshpbar"></div>
      <div id="attackNote"></div>
      <div class="enemy"></div>
    </div>
    <div id="titleContainer">
      <h1 class="title">No Title</h1>
      <input type="button" class="titleAction" value="play" />
      <input type="button" class="titleAction" value="operation" />
      <input type="button" class="titleAction" id="back" value="back" />
      <h1 class="title" id="gameOverText" style="display: none">Game Over</h1>
      <h1 class="title" style="display: none">Operation</h1>
      <h1 class="title" style="display: none">Game Clear</h1>
      <h1 id="titleContent" style="display: none">WASD = ÁßªÂãï</h1>
      <h1 id="resultContent" style="display: none">WASD = ÁßªÂãï</h1>
    </div>

    <audio id="bgm" loop>
      <source src="sounds/Roland BOSS Concert.mp3" type="audio/mpeg" />
    </audio>
    <audio id="se">
      <source src="" type="audio/mpeg" />
    </audio>

    <script type="text/javascript">
      const titleContainer = document.getElementById("titleContainer");
      const gameContainer = document.getElementById("gameContainer");
      const hpbarback = document.getElementById("hpbarback");
      const bosshpbarback = document.getElementById("bosshpbarback");
      const hpbar = document.getElementById("hpbar");
      const bosshpbar = document.getElementById("bosshpbar");
      const player = document.querySelector(".player");
      const playerScene = document.getElementById("player");
      const moveEria = document.querySelector(".moveEria");
      const actionButtons = document.getElementsByClassName("action");
      const titleButtons = document.getElementsByClassName("titleAction");
      const titleButtonBack = document.getElementById("back");
      const title = document.getElementsByClassName("title");
      const UI = document.getElementsByClassName("UI");
      const enemy = document.getElementsByClassName("enemy");
      const bgm = document.getElementById("bgm");
      const se = document.getElementById("se");
      const titleContent = document.getElementById("titleContent");
      const resultContent = document.getElementById("resultContent");
      const UIText = document.getElementById("UIText");
      const itemList = document.getElementsByClassName("itemList");

      //options
      let MAXHP = 100; //player hp
      let attackStr = 10; //player Attack strength
      let speed = 2.3; //player Speed
      let MAXBOSSHP = 100;
      let noteAttackCount = 15; //pattern base Count
      let patternDirayTime = 1500; //ms
      const noteSpeed = 5; //note Speed
      let SoundVolume = { bgm: 0.15, se: 0.5 };
      let attackStrDebug = 0; //debugÁî®

      //ÂàùÊúüË®≠ÂÆö
      let hitCount = 0;
      const baseWidth = 1920;
      const baseHeight = 1080;
      let scale = 1;
      const playerSize = 15;
      const eriaSize = { width: 150, height: 150 };
      const noteSize = { width: 50, height: 10 };
      const buttonSize = { width: 250, height: 100 };
      const uiSize = { width: 100, height: 30 };
      const setLimitEria = { x: 0, y: 100 };
      let limitEria = { x: baseWidth / 2, y: baseHeight / 2 + setLimitEria.y };
      const spawnRadius = 250;
      let x = limitEria.x;
      let y = limitEria.y;
      const keys = {};
      const selectkeys = {};
      let gameScene = "title";
      let animationFrameId = null;
      let selectButtonAnimationFrameId = null;
      let isShowItems = false;
      let avoidanceWidth = 0;
      let avoidanceHeight = 0;
      const baseUp = 50;
      enemy[0].style.display = "block";
      let gamepadIndex = null; // ‰ΩøÁî®„Åô„Çã„Ç≤„Éº„É†„Éë„ÉÉ„Éâ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
      document.getElementById("bgm").volume = SoundVolume.bgm;
      document.getElementById("se").volume = SoundVolume.se;
      let HP = MAXHP; //player hp
      let BossHP = MAXBOSSHP; //Boss HP
      let selectedButtonIndex = 0; // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Éú„Çø„É≥„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
      let itemSelectedButtonIndex = 0;
      let prevGameScene = null;
      let isTriggerPush = false;
      let gamepadPushes = []; // ÂêÑ„Éú„Çø„É≥„ÅÆÊäº‰∏ãÁä∂ÊÖã„ÇíË®òÈå≤
      let buttonState = []; // ÂêÑ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÂ§âÂåñ„ÇíË®òÈå≤ÔºàÊäº„Åó„ÅüÁû¨Èñì„Å´„Å†„ÅëÂèçÂøúÔºâ
      let prevAxisX = 0; // Ââç„Éï„É¨„Éº„É†„ÅÆ„Çπ„ÉÜ„Ç£„ÉÉ„ÇØXËª∏
      let axisYState = null; // YËª∏„ÅÆÁä∂ÊÖã
      let axisXState = null; // „Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅåÂÄí„Çå„ÅüÊñπÂêë„ÇíË®òÈå≤
      const threshold = 0.5; // „Å©„Çå„Åè„Çâ„ÅÑÂÄí„Åó„Åü„ÇâÂèçÂøú„Åô„Çã„Åã
      let Score = 10000;
      const textList = [
        ":„ÅÇ„Å™„Åü„ÅØÂãïÊè∫„Åó„Å¶„ÅÑ„Çã",
        ":„Ç±„ÉÑ„Ç§„ÇíÂõ∫„ÇÅ„Çç",
        ":„ÅÇ„Åç„Çâ„ÇÅ„Çã„Å™",
        ":„Åæ„Å†Â∏åÊúõ„ÅØ„ÅÇ„Çã",
        ":Ë≤†„Åë„Çã„Å™",
      ];

      // „Éá„Éê„Ç¶„É≥„ÇπÈñ¢Êï∞
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // „Çπ„Ç±„Éº„É´‰øÇÊï∞„ÅÆÊõ¥Êñ∞
      function updateScale() {
        const containerWidth = document.body.clientWidth;
        scale = containerWidth / baseWidth;
        console.log("ÁîªÈù¢„Çµ„Ç§„Ç∫„ÅåÂ§â„Çè„Çä„Åæ„Åó„ÅüÔºÅÂπÖ:", containerWidth);
        updateLimitEria();
        updateElements();
      }

      // „É™„Çµ„Ç§„Ç∫„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÔºà„Éá„Éê„Ç¶„É≥„ÇπÈÅ©Áî®Ôºâ
      const debouncedUpdateScale = debounce(updateScale, 100);
      window.addEventListener("resize", debouncedUpdateScale);

      function allReset() {
        // Reset core game variables
        speed = 2.3;
        HP = MAXHP;
        BossHP = MAXBOSSHP;
        x = limitEria.x;
        y = limitEria.y;
        gameScene = "title";
        avoidanceWidth = 0;
        avoidanceHeight = 0;
        selectedButtonIndex = 0;
        itemSelectedButtonIndex = 0;
        isShowItems = false;
        enemy[0].style.display = "block";
        enemy[0].style.opacity = "1"; // Reset enemy opacity
        attackStr = 10; // Reset attack strength

        // Stop all animations
        cancelAnimationFrame(animationFrameId);
        cancelAnimationFrame(selectButtonAnimationFrameId);
        animationFrameId = null;
        selectButtonAnimationFrameId = null;

        // Clear attack notes
        const attackNote = document.getElementById("attackNote");
        attackNote.innerHTML = "";

        // Reset UI text
        UIText.textContent = "";

        // Stop and reset BGM
        //bgm.currentTime = 0;
        //bgm.pause();

        // Reset scale and elements
        updateScale();
        updateSceneDisplay();
      }

      function posReset() {
        x = limitEria.x;
        y = limitEria.y;
      }

      function playSE(src) {
        se.src = src;
        se.play();
      }

      function updateElements() {
        // „Éó„É¨„Ç§„É§„Éº
        player.style.width = playerSize * scale + "px";
        player.style.height = playerSize * scale + "px";
        player.style.left = (x - playerSize / 2) * scale + "px";
        player.style.top = (y - playerSize / 2) * scale + "px";

        // ÁßªÂãï„Ç®„É™„Ç¢
        moveEria.style.width = (eriaSize.width + avoidanceWidth) * scale + "px";
        moveEria.style.height = eriaSize.height * scale + "px";
        setEria(limitEria.x, limitEria.y);

        // HP
        hpbar.style.width = 3 * ((HP / MAXHP) * 100) * scale + "px";
        hpbar.style.height = 20 * scale + "px";
        hpbar.style.left = 1050 * scale + "px";
        hpbar.style.top = (785 - baseUp + 10) * scale + "px";
        hpbarback.style.width = 300 * scale + "px";
        hpbarback.style.height = 20 * scale + "px";
        hpbarback.style.left = 1050 * scale + "px";
        hpbarback.style.top = (785 - baseUp + 10) * scale + "px";

        //EnemyHP
        bosshpbar.style.width = 3 * ((BossHP / MAXBOSSHP) * 100) * scale + "px";
        bosshpbar.style.height = 20 * scale + "px";
        bosshpbar.style.left = (limitEria.x - 300 / 2) * scale + "px";
        bosshpbar.style.top = (450 - baseUp) * scale + "px";
        bosshpbarback.style.width = 300 * scale + "px";
        bosshpbarback.style.height = 20 * scale + "px";
        bosshpbarback.style.left = (limitEria.x - 300 / 2) * scale + "px";
        bosshpbarback.style.top = (450 - baseUp) * scale + "px";

        //Enemy
        enemy[0].style.width = 250 * scale + "px";
        enemy[0].style.height = 250 * scale + "px";
        enemy[0].style.left = (limitEria.x - 250 / 2) * scale + "px";
        enemy[0].style.top = (150 - baseUp) * scale + "px";

        // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
        let width = -575;
        for (const item of actionButtons) {
          item.style.width = buttonSize.width * scale + "px";
          item.style.height = buttonSize.height * scale + "px";
          item.style.left = (baseWidth / 2 + width) * scale + "px";
          item.style.top = (baseHeight / 2 + 300 - baseUp) * scale + "px";
          item.style.fontSize = 50 * scale + "px";
          width += 300;
        }

        // „Ç¢„Ç§„ÉÜ„É†„Éú„Çø„É≥
        let widthitemlist = -100;
        for (const item of itemList) {
          item.style.width = 250 * scale + "px";
          item.style.height = 50 * scale + "px";
          item.style.left = (baseWidth / 2 + widthitemlist) * scale + "px";
          item.style.top = (baseHeight / 2 + 300 - baseUp) * scale + "px";
          item.style.fontSize = 25 * scale + "px";
          width += 320;
        }

        // UI
        let widthUI = -300;
        for (const item of UI) {
          item.style.width = uiSize.width * scale + "px";
          item.style.height = uiSize.height * scale + "px";
          item.style.left = (baseWidth / 2 + widthUI) * scale + "px";
          item.style.top = (baseHeight / 2 + 200 - baseUp + 10) * scale + "px";
          item.style.fontSize = 30 * scale + "px";
          if (item.id === "level") widthUI += 150;
          else if (item.id === "hpLabel") widthUI += 250;
          else widthUI += 100;
        }

        // „Çø„Ç§„Éà„É´Ë¶ÅÁ¥†
        let heightTitle = 0;
        for (const item of titleButtons) {
          item.style.width = buttonSize.width * scale + "px";
          item.style.height = buttonSize.height * scale + "px";
          item.style.left = (baseWidth / 2 - 125) * scale + "px";
          item.style.top =
            (baseHeight / 2 + heightTitle - baseUp) * scale + "px";
          item.style.fontSize = 50 * scale + "px";
          heightTitle += 110;
        }

        titleButtonBack.style.width = buttonSize.width * scale + "px";
        titleButtonBack.style.height = buttonSize.height * scale + "px";
        titleButtonBack.style.left = (baseWidth / 2 - 125) * scale + "px";
        titleButtonBack.style.top =
          (baseHeight / 2 + heightTitle - baseUp) * scale + "px";

        title[0].style.left = (baseWidth / 2 - 125) * scale + "px";
        title[0].style.top = (baseHeight / 2 - 200 - baseUp) * scale + "px";
        title[0].style.fontSize = 60 * scale + "px";
        title[1].style.left = (baseWidth / 2 - 150) * scale + "px";
        title[1].style.top = (baseHeight / 2 - 200 - baseUp) * scale + "px";
        title[1].style.fontSize = 60 * scale + "px";
        title[2].style.left = (baseWidth / 2 - 240) * scale + "px";
        title[2].style.top = (baseHeight / 2 - 500 - baseUp) * scale + "px";
        title[2].style.fontSize = 60 * scale + "px";
        title[3].style.left = (baseWidth / 2 - 190) * scale + "px";
        title[3].style.top = (baseHeight / 2 - 200 - baseUp) * scale + "px";
        title[3].style.fontSize = 60 * scale + "px";

        titleContent.style.left = (baseWidth / 2 - 200) * scale + "px";
        titleContent.style.top = (baseHeight / 2 - 300 - baseUp) * scale + "px";
        titleContent.style.fontSize = 60 * scale + "px";

        resultContent.style.left = (baseWidth / 2 - 320) * scale + "px";
        resultContent.style.top = (baseHeight / 2 - baseUp) * scale + "px";
        resultContent.style.fontSize = 60 * scale + "px";
      }

      // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
      for (const item of actionButtons) {
        item.addEventListener("click", function () {
          console.log(item.value);
          if (BossHP > 0) {
            if (item.value === "‚úñmercy" && gameScene !== "avoidance") {
              playSE("sounds/select.mp3");
              gamepadPushes.fill(false);
              allReset(); // „Ç≤„Éº„É†Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
              gameScene = "title"; // „Çø„Ç§„Éà„É´ÁîªÈù¢„Å´ÈÅ∑Áßª
              updateSceneDisplay(); // ÁîªÈù¢„ÇíÊõ¥Êñ∞
            } else if (gameScene !== "avoidance") {
              if (item.value === "‚öîAttack") {
                BossHP -= attackStr + attackStrDebug;
                playSE("sounds/attack.mp3");
                if (BossHP <= 0) {
                  gameScene = "action"; // Changed from "clear" to "action"
                  bgm.pause(); // BGM„ÇíÂÅúÊ≠¢
                  bgm.currentTime = 0;
                  cancelAnimationFrame(animationFrameId); // „Éó„É¨„Ç§„É§„Éº„ÅÆÁßªÂãï„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÅúÊ≠¢
                  const attackNote = document.getElementById("attackNote");
                  attackNote.innerHTML = ""; // ÊîªÊíÉ„Éé„Éº„Éà„Çí„ÇØ„É™„Ç¢
                  // Fade out the enemy
                  enemy[0].style.opacity = "0"; // Start the fade-out effect
                  setTimeout(() => {
                    enemy[0].style.display = "none"; // Hide the enemy after fading
                    gamepadPushes.fill(false);
                    allReset(); // „Ç≤„Éº„É†Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
                    gameScene = "gameClear"; // „Çø„Ç§„Éà„É´ÁîªÈù¢„Å´ÈÅ∑Áßª
                    updateSceneDisplay(); // ÁîªÈù¢„ÇíÊõ¥Êñ∞
                  }, 1000); // Match the transition duration (1s = 1000ms)
                  // Optionally reset BossHP or other states if needed
                  avoidanceWidth = 900; // Ensure action state dimensions
                  avoidanceHeight = 0;
                  for (const item of itemList) item.style.display = "none";
                  UIText.textContent = "„Éú„Çπ„ÇíÂÄí„Åó„ÅüÔºÅ"; // Optional message
                  updateElements();
                  return;
                }
                enemy[0].style.backgroundColor = "red";
                setTimeout(() => {
                  enemy[0].style.backgroundColor = "white";
                }, 100);
                gameScene = "avoidance";
                isShowItems = false;
                updateSceneDisplay();
              } else if (item.value === "üõçitem") {
                playSE("sounds/select.mp3");
                if (isShowItems) {
                  isShowItems = false;
                } else {
                  isShowItems = true;
                }
                updateSceneDisplay();
              } else if (item.value === "üì∂action") {
                playSE("sounds/select.mp3");
                isShowItems = false;
                actionNumfun();
              } else {
                playSE("sounds/select.mp3");
                gameScene = "avoidance";
                isShowItems = false;
                updateSceneDisplay();
              }
            }
          }
        });
      }

      function actionNumfun() {
        let actionNum = Math.floor(Math.random() * 2);
        avoidanceHeight = 0;
        for (const item of itemList) item.style.display = "none";
        updateElements();
        switch (actionNum) {
          case 0:
            UIText.textContent = "„Åì„Å∂„Åó„Å´Âäõ„ÇíËæº„ÇÅ„Åü";
            attackStr += 2;
            setTimeout(() => {
              UIText.textContent = `ÊîªÊíÉÂäõ„Åå2‰∏äÊòá„Åó„Åü`;
            }, 500);
            break;
          case 1:
            UIText.textContent = "„Ç±„ÉÑ„Ç§„ÇíÊ±∫„ÇÅ„Åü";
            HP += 30;
            setTimeout(() => {
              UIText.textContent = `‰ΩìÂäõ„Åå30ÂõûÂæ©„Åó„Åü`;
            }, 500);
            playSE("sounds/heal.mp3");
            break;
        }
        if (HP > MAXHP) {
          HP = MAXHP;
        }
        setTimeout(() => {
          gameScene = "avoidance";
          updateSceneDisplay();
        }, 1000);
      }

      // „Çø„Ç§„Éà„É´„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
      for (const item of titleButtons) {
        item.addEventListener("click", function () {
          console.log(item.value);
          if (item.value === "play") {
            allReset();
            Score = 10000;
            hitCount = 0;
            gameScene = "action";
            updateSceneDisplay();
          } else if (item.value === "operation") {
            gameScene = "operation";
            updateSceneDisplay();
          } else if (item.value === "back") {
            gameScene = "title";
            updateSceneDisplay();
          }
          playSE("sounds/select.mp3");
        });
      }

      // „Ç¢„Ç§„ÉÜ„É†„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
      for (const item of itemList) {
        item.addEventListener("click", function () {
          console.log(item.value);
          if (item.value == "„Éê„Çø„Çπ„Ç≥") {
            HP += 30;
          } else if (item.value == "Â§¢") {
            HP += 20;
          }
          if (HP > 100) {
            HP = 100;
          }
          isShowItems = false;
          playSE("sounds/heal.mp3");
          gameScene = "avoidance";
          updateSceneDisplay();
        });
      }

      function updateSceneDisplay() {
        if (gameScene === "avoidance") {
          posReset();
          titleContainer.style.display = "none";
          gameContainer.style.display = "block";
          avoidanceWidth = 0;
          avoidanceHeight = 0;
          for (const item of itemList) item.style.display = "none";
          playerScene.style.display = "block";
          moveEria.style.display = "block";
          for (const item of actionButtons) item.style.display = "block";
          for (const item of UI) item.style.display = "block";
          hpbar.style.display = "block";
          hpbarback.style.display = "block";
          title[0].style.display = "block";
          title[1].style.display = "none";
          title[2].style.display = "none";
          titleContent.style.display = "none";
          resultContent.style.display = "none";
          UIText.textContent = "";
          updateLimitEria();
          // „Éï„Ç©„Éº„Ç´„Çπ„Çí„Ç≤„Éº„É†ÁîªÈù¢„Å´Ë®≠ÂÆö
          document.body.focus();
          // „Éó„É¨„Ç§„É§„ÉºÁßªÂãïÈñãÂßã
          movePlayer();
          setTimeout(() => {
            createNote();
          }, 500);
          selectButton();
          updateElements();
        } else if (gameScene === "action") {
          console.log("playsound");
          bgm.play();
          titleContainer.style.display = "none";
          gameContainer.style.display = "block";
          avoidanceWidth = 900;
          playerScene.style.display = "none";
          moveEria.style.display = "block";
          for (const item of actionButtons) item.style.display = "block";
          for (const item of UI) item.style.display = "block";
          hpbar.style.display = "block";
          hpbarback.style.display = "block";
          title[0].style.display = "block";
          title[1].style.display = "none";
          title[2].style.display = "none";
          title[3].style.display = "none";
          titleContent.style.display = "none";
          resultContent.style.display = "none";
          cancelAnimationFrame(animationFrameId);
          const attackNote = document.getElementById("attackNote");
          attackNote.innerHTML = "";
          let textRnd = Math.floor(Math.random() * textList.length);
          UIText.textContent = textList[textRnd];
          if (isShowItems) {
            UIText.textContent = "";
            avoidanceHeight = 100;
            for (const item of itemList) item.style.display = "block";
          } else {
            avoidanceHeight = 0;
            for (const item of itemList) item.style.display = "none";
          }
          selectButton();
          updateElements();
        } else if (gameScene === "title") {
          bgm.pause(); // BGM„ÇíÂÅúÊ≠¢
          bgm.currentTime = 0;
          titleContainer.style.display = "block";
          gameContainer.style.display = "none";
          titleButtons[0].style.display = "block";
          titleButtons[1].style.display = "block";
          titleButtonBack.style.display = "none";
          title[0].style.display = "block";
          title[1].style.display = "none";
          title[2].style.display = "none";
          title[3].style.display = "none";
          titleContent.style.display = "none";
          resultContent.style.display = "none";
          selectButton();
          updateElements();
        } else if (gameScene === "gameOver") {
          bgm.pause(); // BGM„ÇíÂÅúÊ≠¢
          bgm.currentTime = 0;
          resultContent.innerHTML = `HitÂõûÊï∞: ${hitCount}<br>„ÅÇ„Å™„Åü„ÅÆ„Çπ„Ç≥„Ç¢: ${Score}`;
          titleContainer.style.display = "block";
          gameContainer.style.display = "none";
          titleButtons[0].style.display = "none";
          titleButtons[1].style.display = "none";
          titleButtonBack.style.display = "block";
          title[0].style.display = "none";
          title[1].style.display = "block";
          title[2].style.display = "none";
          title[3].style.display = "none";
          titleContent.style.display = "none";
          resultContent.style.display = "block";
          selectButton();
          updateElements();
        } else if (gameScene === "gameClear") {
          console.log(hitCount);
          resultContent.innerHTML = `HitÂõûÊï∞: ${hitCount}<br>„ÅÇ„Å™„Åü„ÅÆ„Çπ„Ç≥„Ç¢: ${Score}`;
          bgm.pause(); // BGM„ÇíÂÅúÊ≠¢
          bgm.currentTime = 0;
          titleContainer.style.display = "block";
          gameContainer.style.display = "none";
          titleButtons[0].style.display = "none";
          titleButtons[1].style.display = "none";
          titleButtonBack.style.display = "block";
          title[0].style.display = "none";
          title[1].style.display = "none";
          title[2].style.display = "none";
          title[3].style.display = "block";
          titleContent.style.display = "none";
          resultContent.style.display = "block";
          selectButton();
          updateElements();
        } else if (gameScene === "operation") {
          bgm.pause(); // BGM„ÇíÂÅúÊ≠¢
          bgm.currentTime = 0;
          titleContainer.style.display = "block";
          gameContainer.style.display = "none";
          titleButtons[0].style.display = "none";
          titleButtons[1].style.display = "none";
          titleButtonBack.style.display = "block";
          title[0].style.display = "none";
          title[1].style.display = "none";
          title[2].style.display = "none";
          title[3].style.display = "none";
          titleContent.style.display = "block";
          resultContent.style.display = "none";
          selectButton();
          updateElements();
        }
      }

      function movePlayer() {
        if (gameScene !== "avoidance") {
          cancelAnimationFrame(animationFrameId);
          return;
        }

        const halfWidth = (eriaSize.width + avoidanceWidth) / 2;
        const halfHeight = (eriaSize.height + avoidanceHeight) / 2;

        // „Ç≠„ÉºÂÖ•ÂäõÔºàWASDÔºâ
        let moveX = 0;
        let moveY = 0;
        if (keys.w) moveY -= speed;
        if (keys.s) moveY += speed;
        if (keys.a) moveX -= speed;
        if (keys.d) moveX += speed;

        // „Ç≤„Éº„É†„Éë„ÉÉ„ÉâÂÖ•Âäõ
        if (gamepadIndex !== null) {
          const gamepad = navigator.getGamepads()[gamepadIndex];
          if (gamepad && gamepad.connected) {
            // Â∑¶„Ç¢„Éä„É≠„Ç∞„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÔºàaxes[0]: Â∑¶Âè≥, axes[1]: ‰∏ä‰∏ãÔºâ
            const stickX =
              Math.abs(gamepad.axes[0]) > deadZone ? gamepad.axes[0] : 0;
            const stickY =
              Math.abs(gamepad.axes[1]) > deadZone ? gamepad.axes[1] : 0;

            // „Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅÆÂÖ•Âäõ„Å´Âü∫„Å•„ÅÑ„Å¶ÁßªÂãïÈáè„ÇíË®àÁÆó
            moveX += stickX * speed;
            moveY += stickY * speed;
          }
        }

        // ÁßªÂãïÈáè„ÇíÈÅ©Áî®
        x += moveX;
        y += moveY;

        // ÁßªÂãï„Ç®„É™„Ç¢ÂÜÖ„Å´Âà∂Èôê
        x = Math.max(
          limitEria.x - halfWidth,
          Math.min(x, limitEria.x + halfWidth - playerSize)
        );
        y = Math.max(
          limitEria.y - halfHeight,
          Math.min(y, limitEria.y + halfHeight - playerSize)
        );

        // „Éó„É¨„Ç§„É§„Éº„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
        player.style.left = x * scale + "px";
        player.style.top = y * scale + "px";
        animationFrameId = requestAnimationFrame(movePlayer);
      }

      function selectButton() {
        // „Ç∑„Éº„É≥„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„Å´ÂàùÊúüÂåñ
        let gamepadbutton = null;
        if (gamepadIndex !== null) {
          const gamepad = navigator.getGamepads()[gamepadIndex];
          if (!gamepad) return;
          gamepad.buttons[0] = false;

          // „Éú„Çø„É≥Âá¶ÁêÜ
          for (let i = 0; i < gamepad.buttons.length; i++) {
            const isPressed = gamepad.buttons[i].pressed;

            // Êäº„Åó„ÅüÁû¨Èñì„ÅÆ„ÅøÂèçÂøúÔºàÈï∑Êäº„ÅóÁÑ°Ë¶ñÔºâ
            if (isPressed !== gamepadPushes[i]) {
              gamepadPushes[i] = isPressed; // Áä∂ÊÖã„ÇíÊõ¥Êñ∞

              if (isPressed) {
                console.log(`„Éú„Çø„É≥${i}„ÇíÊäº„Åó„ÅüÔºÅ`);

                // „Éú„Çø„É≥0„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ„Çπ„Éö„Éº„Çπ„Ç≠„Éº„ÅÆ‰ª£„Çè„Çä„Å´‰Ωø„ÅÜ
                if (i === 0) {
                  selectkeys.space = true;
                }
              } else {
                // „Éú„Çø„É≥0„ÅåÈõ¢„Åï„Çå„ÅüÂ†¥Âêà
                if (i === 0) {
                  selectkeys.space = false;
                }
              }
            }
          }
          // „Çπ„ÉÜ„Ç£„ÉÉ„ÇØÂá¶ÁêÜ
          const axisX = gamepad.axes[0]; // -1ÔΩû+1„ÅÆÁØÑÂõ≤
          const axisY = gamepad.axes[1]; // -1ÔΩû+1„ÅÆÁØÑÂõ≤

          // Âè≥„Å´ÂÄí„Åó„ÅüÁû¨Èñì (XËª∏)
          if (axisX > threshold && axisXState !== "right") {
            console.log("Âè≥„Å´ÂÄí„Åó„ÅüÔºÅ");
            selectkeys.d = true;
            axisXState = "right"; // Âè≥„Å´ÂÄí„Çå„Åü„Åì„Å®„ÇíË®òÈå≤
          }

          // Â∑¶„Å´ÂÄí„Åó„ÅüÁû¨Èñì (XËª∏)
          if (axisX < -threshold && axisXState !== "left") {
            console.log("Â∑¶„Å´ÂÄí„Åó„ÅüÔºÅ");
            selectkeys.a = true;
            axisXState = "left"; // Â∑¶„Å´ÂÄí„Çå„Åü„Åì„Å®„ÇíË®òÈå≤
          }

          // ‰∏ä„Å´ÂÄí„Åó„ÅüÁû¨Èñì (YËª∏)
          if (axisY > threshold && axisYState !== "up") {
            console.log("‰∏ä„Å´ÂÄí„Åó„ÅüÔºÅ");
            selectkeys.w = true;
            axisYState = "up"; // ‰∏ä„Å´ÂÄí„Çå„Åü„Åì„Å®„ÇíË®òÈå≤
          }

          // ‰∏ã„Å´ÂÄí„Åó„ÅüÁû¨Èñì (YËª∏)
          if (axisY < -threshold && axisYState !== "down") {
            console.log("‰∏ã„Å´ÂÄí„Åó„ÅüÔºÅ");
            selectkeys.s = true;
            axisYState = "down"; // ‰∏ã„Å´ÂÄí„Çå„Åü„Åì„Å®„ÇíË®òÈå≤
          }

          // Áúü„Çì‰∏≠„Å´Êàª„Åó„ÅüÁû¨Èñì (XËª∏„Å®YËª∏)
          if (Math.abs(axisX) < threshold && axisXState !== null) {
            console.log("X„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÊàª„Åó„ÅüÔºÅ");
            selectkeys.d = false;
            selectkeys.a = false;
            axisXState = null; // X„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅåÊàª„Å£„Åü„Åì„Å®„ÇíË®òÈå≤
          }

          if (Math.abs(axisY) < threshold && axisYState !== null) {
            console.log("Y„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÊàª„Åó„ÅüÔºÅ");
            selectkeys.w = false;
            selectkeys.s = false;
            axisYState = null; // Y„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅåÊàª„Å£„Åü„Åì„Å®„ÇíË®òÈå≤
          }
        }
        if (prevGameScene !== gameScene) {
          if (gameScene === "title") {
            for (const item of titleButtons)
              item.style.border = "4px solid orange";
            selectedButtonIndex = 0;
            titleButtons[selectedButtonIndex].style.border = "4px solid red";
          } else if (gameScene === "operation" || gameScene === "gameOver") {
            titleButtons[selectedButtonIndex].style.border = "4px solid red";
          } else if (gameScene === "action") {
            for (const item of actionButtons)
              item.style.border = "4px solid orange";
            itemSelectedButtonIndex = 0;
            actionButtons[itemSelectedButtonIndex].style.border =
              "4px solid red";
          }
          prevGameScene = gameScene;
        }
        // ‰∏ä„Å´ÁßªÂãï (w„Ç≠„Éº)
        if (selectkeys.w) {
          if (gameScene === "title") {
            for (const item of titleButtons)
              item.style.border = "4px solid orange";
            selectedButtonIndex++;
            if (selectedButtonIndex >= 2) {
              selectedButtonIndex = 0;
            }
            titleButtons[selectedButtonIndex].style.border = "4px solid red";
            console.log(selectedButtonIndex);
          }
          if (gameScene === "action") {
            for (const item of itemList) item.style.border = "4px solid orange";
            itemSelectedButtonIndex--;
            if (itemSelectedButtonIndex < 0) {
              itemSelectedButtonIndex = itemList.length - 1;
            }
            itemList[itemSelectedButtonIndex].style.border = "4px solid red";
            console.log(itemSelectedButtonIndex);
          }
          selectkeys.w = false; // ÈÄ£Á∂öÁßªÂãïÈò≤Ê≠¢Ôºà„Éá„Éê„Ç¶„É≥„ÇπÔºâ
        }

        // ‰∏ã„Å´ÁßªÂãï (s„Ç≠„Éº)
        if (selectkeys.s) {
          if (gameScene === "title") {
            for (const item of titleButtons)
              item.style.border = "4px solid orange";
            selectedButtonIndex--;
            if (selectedButtonIndex < 0) {
              selectedButtonIndex = 1;
            }
            titleButtons[selectedButtonIndex].style.border = "4px solid red";
            console.log(selectedButtonIndex);
          }
          if (gameScene === "action") {
            for (const item of itemList) item.style.border = "4px solid orange";
            itemSelectedButtonIndex++;
            if (itemSelectedButtonIndex >= itemList.length) {
              itemSelectedButtonIndex = 0;
            }
            itemList[itemSelectedButtonIndex].style.border = "4px solid red";
            console.log(itemSelectedButtonIndex);
          }
          selectkeys.s = false; // ÈÄ£Á∂öÁßªÂãïÈò≤Ê≠¢Ôºà„Éá„Éê„Ç¶„É≥„ÇπÔºâ
        }

        // Âè≥„Å´ÁßªÂãï (w„Ç≠„Éº)
        if (selectkeys.a) {
          if (gameScene === "action") {
            for (const item of actionButtons)
              item.style.border = "4px solid orange";
            selectedButtonIndex--;
            if (selectedButtonIndex < 0) {
              selectedButtonIndex = actionButtons.length - 1;
            }
            actionButtons[selectedButtonIndex].style.border = "4px solid red";
            console.log(selectedButtonIndex);
          }
          selectkeys.a = false; // ÈÄ£Á∂öÁßªÂãïÈò≤Ê≠¢Ôºà„Éá„Éê„Ç¶„É≥„ÇπÔºâ
        }

        // Â∑¶„Å´ÁßªÂãï (s„Ç≠„Éº)
        if (selectkeys.d) {
          if (gameScene === "action") {
            for (const item of actionButtons)
              item.style.border = "4px solid orange";
            selectedButtonIndex++;
            if (selectedButtonIndex >= actionButtons.length) {
              selectedButtonIndex = 0;
            }
            actionButtons[selectedButtonIndex].style.border = "4px solid red";
            console.log(selectedButtonIndex);
          }
          selectkeys.d = false; // ÈÄ£Á∂öÁßªÂãïÈò≤Ê≠¢Ôºà„Éá„Éê„Ç¶„É≥„ÇπÔºâ
        }
        // „Éú„Çø„É≥„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ (space„Ç≠„Éº)
        if (selectkeys.space || selectkeys.enter) {
          if (gameScene === "title") {
            titleButtons[selectedButtonIndex].click();
          } else if (gameScene === "action") {
            if (!isShowItems) {
              actionButtons[selectedButtonIndex].click();
              selectedButtonIndex = 0;
            } else {
              itemList[selectedButtonIndex].click();
              selectedButtonIndex = 0;
            }
          } else if (
            gameScene === "operation" ||
            gameScene === "gameOver" ||
            gameScene === "gameClear"
          ) {
            if (selectedButtonIndex == 2) {
              gamepadPushes.fill(false);
              allReset(); // „Ç≤„Éº„É†Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
              gameScene = "title"; // „Çø„Ç§„Éà„É´ÁîªÈù¢„Å´ÈÅ∑Áßª
              updateSceneDisplay(); // ÁîªÈù¢„ÇíÊõ¥Êñ∞
            }
            titleButtonBack.style.border = "4px solid red";
            selectedButtonIndex = 2;
          }
          selectkeys.space = false; // „Çπ„Éö„Éº„Çπ„Ç≠„Éº„ÅÆ„É™„Çª„ÉÉ„Éà„ÅØ1Âõû„Å†„Åë
          selectkeys.enter = false;
        }
        selectButtonAnimationFrameId = requestAnimationFrame(selectButton);
      }

      function setEria(x, y) {
        const halfWidth = (eriaSize.width + avoidanceWidth) / 2;
        const halfHeight = (eriaSize.height + avoidanceHeight) / 2;

        moveEria.style.left = (x - halfWidth - 6 / scale) * scale + "px";
        moveEria.style.top = (y - halfHeight - 6 / scale) * scale + "px";
        moveEria.style.width = (eriaSize.width + avoidanceWidth) * scale + "px";
        moveEria.style.height =
          (eriaSize.height + avoidanceHeight) * scale + "px";
      }

      function updateLimitEria() {
        limitEria = {
          x: baseWidth / 2 + setLimitEria.x,
          y: baseHeight / 2 + setLimitEria.y,
        };
        setEria(limitEria.x, limitEria.y);
      }

      function createNote() {
        const attackNote = document.getElementById("attackNote");
        const centerX = limitEria.x;
        const centerY = limitEria.y;
        const spawnInterval = 5; // Ê¨°„ÅÆ„Éë„Çø„Éº„É≥„Åæ„Åß„ÅÆÂü∫Êú¨ÈñìÈöîÔºà„Éü„É™ÁßíÔºâ
        const totalDuration = Math.floor(Math.random() * 6) + noteAttackCount; // ÊîªÊíÉ„Éï„Çß„Éº„Ç∫„ÅÆÂêàË®àÂõûÊï∞Ôºà„Éü„É™ÁßíÔºâ
        let spawnCount = 0;
        let activeNotes = 0; // ÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éé„Éº„Éà„ÅÆÊï∞
        let isPatternRunning = false; // „Éë„Çø„Éº„É≥ÂÆüË°å‰∏≠„Éï„É©„Ç∞
        const currentDistance = 350;

        // Âçò‰∏Ä„ÅÆ„Éé„Éº„Éà„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞
        function createSingleNote(startX, startY, vx, vy) {
          const note = document.createElement("div");
          note.className = "attackNote";
          attackNote.appendChild(note);

          note.style.left = (startX - noteSize.width / 2) * scale + "px";
          note.style.top = startY * scale + "px";
          note.style.width = noteSize.width * scale + "px";
          note.style.height = noteSize.height * scale + "px";

          const rotation = (Math.atan2(vy, vx) * 180) / Math.PI;
          note.style.transform = `rotate(${rotation}deg)`;

          activeNotes++; // „Éé„Éº„ÉàÁîüÊàêÊôÇ„Å´„Ç´„Ç¶„É≥„ÉàÂ¢ó
          return { note, posX: startX, posY: startY };
        }

        // „Éé„Éº„Éà„ÅÆÁßªÂãï„Å®Ë°ùÁ™ÅÂà§ÂÆö„ÇíÂá¶ÁêÜ„Åô„ÇãÈñ¢Êï∞
        function moveNote(noteObj, vx, vy) {
          const { note, posX: initialX, posY: initialY } = noteObj;
          let posX = initialX;
          let posY = initialY;

          const moveInterval = setInterval(() => {
            posX += vx;
            posY += vy;
            note.style.left =
              (posX - (noteObj.size?.width || 0) / 2) * scale + "px";
            note.style.top =
              (posY - (noteObj.size?.height || 0) / 2) * scale + "px";

            if (checkCollision(note)) {
              hitCount++;
              Score -= 10;
              playSE("sounds/damage.mp3");
              console.log("„Éó„É¨„Ç§„É§„Éº„Å®„Éé„Éº„Éà„ÅåË°ùÁ™Å„Åó„Åæ„Åó„ÅüÔºÅ");
              HP = Math.max(0, HP - 2);
              updateElements();
              clearInterval(moveInterval);
              note.remove();
              activeNotes--; // „Éé„Éº„ÉàÂâäÈô§ÊôÇ„Å´„Ç´„Ç¶„É≥„ÉàÊ∏õ
              checkPatternCompletion(false); // Ë°ùÁ™ÅÊôÇ„ÅØÊ¨°„ÅÆ„Éë„Çø„Éº„É≥„ÇíÂç≥Â∫ß„Å´ÈñãÂßã„Åó„Å™„ÅÑ
              if (HP <= 0) {
                gameScene = "gameOver";
                bgm.pause(); // BGM„ÇíÂÅúÊ≠¢
                bgm.currentTime = 0;
                cancelAnimationFrame(animationFrameId); // „Éó„É¨„Ç§„É§„Éº„ÅÆÁßªÂãï„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÅúÊ≠¢
                const attackNote = document.getElementById("attackNote");
                attackNote.innerHTML = ""; // ÊîªÊíÉ„Éé„Éº„Éà„Çí„ÇØ„É™„Ç¢
                updateSceneDisplay();
                return;
              }
            }
          }, 16);

          setTimeout(() => {
            clearInterval(moveInterval);
            note.remove();
            activeNotes--; // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÊôÇ„Å´„ÇÇ„Ç´„Ç¶„É≥„ÉàÊ∏õ
            checkPatternCompletion(true); // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÊôÇ„ÅØ„Éë„Çø„Éº„É≥ÂÆå‰∫Ü„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            console.log("Note timeout");
          }, 1500);
        }

        // „Éë„Çø„Éº„É≥ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
        function checkPatternCompletion(isTimeout = false) {
          if (HP <= 0 || BossHP <= 0) {
            return; // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
          }
        }

        const notePatterns = [
          spawnPattern1,
          spawnPattern2,
          spawnPattern2,
          spawnPattern2,
          spawnPattern3,
          spawnPattern3,
          spawnPattern4,
          spawnPattern5,
          spawnPattern5,
        ];

        function spawnNotes() {
          if (spawnCount >= totalDuration && gameScene == "avoidance") {
            console.log("ÊîªÊíÉ„Éï„Çß„Éº„Ç∫ÁµÇ‰∫Ü");
            gameScene = "action";
            updateSceneDisplay();
            return;
          }

          if (gameScene === "avoidance") {
            isPatternRunning = true;
            const selectPattern = Math.floor(
              Math.random() * notePatterns.length
            );
            console.log(`ÈÅ∏Êäû„Åï„Çå„Åü„Éë„Çø„Éº„É≥: ${selectPattern}`);
            notePatterns[selectPattern]();
            spawnCount++;
            setTimeout(spawnNotes, patternDirayTime); // 1.5ÁßíÂæå„Å´Ê¨°„ÅÆ„Éë„Çø„Éº„É≥„ÇíÂëº„Å≥Âá∫„Åó
          }
        }

        // ÊîªÊíÉ„Éï„Çß„Éº„Ç∫ÈñãÂßã
        if (gameScene === "avoidance") {
          spawnNotes();
        }

        // „Éé„Éº„Éà„Éë„Çø„Éº„É≥1: „É©„É≥„ÉÄ„É†„Å™ËßíÂ∫¶„Åß5„Å§„ÅÆ„Éé„Éº„Éà„ÇíÁîüÊàê
        function spawnPattern1() {
          for (let i = 0; i < Math.floor(Math.random() * 4) + 3; i++) {
            const angle = Math.random() * 2 * Math.PI;
            const startX = centerX + spawnRadius * Math.cos(angle);
            const startY = centerY + spawnRadius * Math.sin(angle);

            const dx = x - startX;
            const dy = y - startY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const vx = (dx / distance) * noteSpeed;
            const vy = (dy / distance) * noteSpeed;

            const noteObj = createSingleNote(startX, startY, vx, vy);
            moveNote(noteObj, vx, vy);
          }
        }

        // „Éé„Éº„Éà„Éë„Çø„Éº„É≥2: Âõ∫ÂÆö‰ΩçÁΩÆ„Åã„Çâ5„Å§„ÅÆ„Éé„Éº„Éà„ÇíÁîüÊàê
        function spawnPattern2() {
          const halfWidth = (eriaSize.width + avoidanceWidth) / 2;
          const halfHeight = (eriaSize.height + avoidanceHeight) / 2;
          const buffer = 200;

          for (let i = 0; i < Math.floor(Math.random() * 4) + 3; i++) {
            let startX, startY, vx, vy;
            const side = Math.floor(Math.random() * 4);

            switch (side) {
              case 0:
                startX = limitEria.x - halfWidth - buffer;
                startY = limitEria.y + (Math.random() * 2 - 1) * halfHeight;
                vx = noteSpeed;
                vy = 0;
                break;
              case 1:
                startX = limitEria.x + halfWidth + buffer;
                startY = limitEria.y + (Math.random() * 2 - 1) * halfHeight;
                vx = -noteSpeed;
                vy = 0;
                break;
              case 2:
                startX = limitEria.x + (Math.random() * 2 - 1) * halfWidth;
                startY = limitEria.y - halfHeight - buffer;
                vx = 0;
                vy = noteSpeed;
                break;
              case 3:
                startX = limitEria.x + (Math.random() * 2 - 1) * halfWidth;
                startY = limitEria.y + halfHeight + buffer;
                vx = 0;
                vy = -noteSpeed;
                break;
            }

            const noteObj = createSingleNote(startX, startY, vx, vy);
            moveNote(noteObj, vx, vy);
          }
        }

        function spawnPattern3() {
          playSE("sounds/beamset.mp3");
          const halfWidth = (eriaSize.width + avoidanceWidth) / 2;
          const halfHeight = (eriaSize.height + avoidanceHeight) / 2;
          const buffer = 330;
          const beamSpeed = noteSpeed * 2;
          const beamNoteSize = { width: 200, height: 10 };
          const moveDelay = 800;

          for (let i = 0; i < 4; i++) {
            let startX, startY, vx, vy;
            const side = Math.floor(Math.random() * 2);

            switch (side) {
              case 0:
                startX =
                  limitEria.x -
                  beamNoteSize.width / 2 -
                  halfWidth -
                  buffer +
                  100;
                startY = limitEria.y + (Math.random() * 2 - 1) * halfHeight;
                vx = beamSpeed;
                vy = 0;
                break;
              case 1:
                startX =
                  limitEria.x -
                  beamNoteSize.width / 2 +
                  halfWidth +
                  buffer +
                  100;
                startY = limitEria.y + (Math.random() * 2 - 1) * halfHeight;
                vx = -beamSpeed;
                vy = 0;
                break;
            }

            // „Éì„Éº„É†„Éé„Éº„Éà„ÅÆÁîüÊàê
            const note = document.createElement("div");
            note.className = "beamNote";
            document.getElementById("attackNote").appendChild(note);

            note.style.left = startX * scale + "px";
            note.style.top = startY * scale + "px";
            note.style.width = beamNoteSize.width * scale + "px";
            note.style.height = beamNoteSize.height * scale + "px";

            // ‰∫àÊ∏¨Á∑ö„ÅÆÁîüÊàê
            const noteAria = document.createElement("div");
            noteAria.className = "beamNoteAria";
            document.getElementById("attackNote").appendChild(noteAria);
            noteAria.style.left = startX * scale + "px";
            noteAria.style.top = startY * scale + "px";
            noteAria.style.width = beamNoteSize.width * scale * 5 + "px"; // ‰∫àÊ∏¨Á∑ö„ÇíÈï∑„Åè
            noteAria.style.height = beamNoteSize.height * scale + "px";
            noteAria.style.opacity = "0.5"; // ÂçäÈÄèÊòé„ÅßË¶ñË™çÊÄßÁ¢∫‰øù
            noteAria.style.backgroundColor = "rgba(255, 50, 50, 0.3)"; // Ëµ§„Å£„ÅΩ„ÅÑËâ≤„ÅßÂç±Èô∫„ÇíÁ§∫„Åô
            noteAria.style.transition = "opacity 0.3s"; // „Éï„Çß„Éº„Éâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®

            // „Éì„Éº„É†„Å®‰∫àÊ∏¨Á∑ö„ÅÆÂõûËª¢
            const rotation = (Math.atan2(vy, vx) * 180) / Math.PI;
            note.style.transform = `rotate(${rotation}deg)`;
            noteAria.style.transform = `rotate(${rotation}deg)`;

            activeNotes++; // „Éì„Éº„É†„ÇÇ„Ç´„Ç¶„É≥„Éà
            const noteObj = { note, posX: startX, posY: startY };

            // ‰∫àÊ∏¨Á∑ö„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å®ÁßªÂãïÂá¶ÁêÜ
            setTimeout(() => {
              // „Éì„Éº„É†ÁßªÂãïÈñãÂßãÊôÇ„Å´‰∫àÊ∏¨Á∑ö„Çí„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
              noteAria.style.opacity = "0";
              moveNote(noteObj, vx, vy);
              // ‰∫àÊ∏¨Á∑ö„ÇíÂ∞ë„ÅóÈÅÖ„Çå„Å¶ÂÆåÂÖ®„Å´ÂâäÈô§
              setTimeout(() => {
                noteAria.remove();
              }, 300);
            }, moveDelay);

            // ‰∫àÊ∏¨Á∑ö„ÇíÁÇπÊªÖ„Åï„Åõ„ÇãÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            let blinkCount = 0;
            const blinkInterval = setInterval(() => {
              noteAria.style.opacity = blinkCount % 2 === 0 ? "0.5" : "0.2";
              blinkCount++;
              if (blinkCount >= 6) clearInterval(blinkInterval); // 3ÂõûÁÇπÊªÖ„Åó„Åü„ÇâÁµÇ‰∫Ü
            }, 200);
          }
        }

        // „Éé„Éº„Éà„Éë„Çø„Éº„É≥4: ÂÜÜÂΩ¢„Å´ÈÖçÁΩÆ„Åó„ÄÅÈ†ÜÁï™„Å´‰∏≠ÂøÉ„Å´Âêë„Åã„Å£„Å¶ÁßªÂãï
        function spawnPattern4() {
          const halfWidth = (eriaSize.width + avoidanceWidth) / 2;
          const halfHeight = (eriaSize.height + avoidanceHeight) / 2;
          const radius = Math.min(halfWidth, halfHeight) * 3;
          const noteCount = Math.floor(Math.random() * 11) + 10;
          const waitTime = 250;
          const moveDelay = 300;

          for (let i = 0; i < noteCount; i++) {
            playSE("sounds/noteset1.mp3");
            const angle = (i / noteCount) * 2 * Math.PI;
            const startX = limitEria.x + radius * Math.cos(angle);
            const startY = limitEria.y + radius * Math.sin(angle);

            const dx = centerX - startX;
            const dy = centerY - startY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const vx = (dx / distance) * noteSpeed;
            const vy = (dy / distance) * noteSpeed;

            const noteObj = createSingleNote(startX, startY, vx, vy);
            setTimeout(() => {
              moveNote(noteObj, vx, vy);
            }, waitTime + i * moveDelay);
          }
        }

        function spawnPattern5() {
          playSE("sounds/beamset.mp3");
          const halfWidth = (eriaSize.width + avoidanceWidth) / 2;
          const halfHeight = (eriaSize.height + avoidanceHeight) / 2;
          const buffer = 330;
          const beamSpeed = noteSpeed * 2;
          const beamNoteSize = { width: 200, height: 10 };
          const moveDelay = 800;

          for (let i = 0; i < 4; i++) {
            let startX, startY, vx, vy;
            const side = Math.floor(Math.random() * 2);

            switch (side) {
              case 0: // Top
                startX = limitEria.x + (Math.random() * 2 - 1) * halfWidth;
                startY =
                  limitEria.y - beamNoteSize.height / 2 - halfHeight - buffer;
                vx = 0;
                vy = beamSpeed;
                break;
              case 1: // Bottom
                startX = limitEria.x + (Math.random() * 2 - 1) * halfWidth;
                startY =
                  limitEria.y + beamNoteSize.height / 2 + halfHeight + buffer;
                vx = 0;
                vy = -beamSpeed;
                break;
            }

            // „Éì„Éº„É†„Éé„Éº„Éà„ÅÆÁîüÊàê
            const note = document.createElement("div");
            note.className = "beamNote";
            document.getElementById("attackNote").appendChild(note);
            startX += 100;
            note.style.left = (startX - beamNoteSize.width / 2) * scale + "px"; // Center horizontally
            note.style.top = (startY - beamNoteSize.height / 2) * scale + "px"; // Center vertically
            note.style.width = beamNoteSize.width * scale + "px";
            note.style.height = beamNoteSize.height * scale + "px";

            // ‰∫àÊ∏¨Á∑ö„ÅÆÁîüÊàê
            const noteAria = document.createElement("div");
            noteAria.className = "beamNoteAria";
            document.getElementById("attackNote").appendChild(noteAria);
            noteAria.style.left =
              (startX - beamNoteSize.width / 2) * scale + "px"; // Match note's centering
            noteAria.style.top =
              (startY - beamNoteSize.height / 2) * scale + "px";
            noteAria.style.width = beamNoteSize.width * scale * 5 + "px"; // Fixed: match beam width
            noteAria.style.height = beamNoteSize.height * scale + "px"; // Vertical prediction line
            noteAria.style.opacity = "0.5";
            noteAria.style.backgroundColor = "rgba(255, 50, 50, 0.3)";
            noteAria.style.transition = "opacity 0.3s";

            // „Éì„Éº„É†„Å®‰∫àÊ∏¨Á∑ö„ÅÆÂõûËª¢
            const rotation = (Math.atan2(vy, vx) * 180) / Math.PI;
            note.style.transform = `rotate(${rotation}deg)`;
            noteAria.style.transform = `rotate(${rotation}deg)`;

            activeNotes++;
            const noteObj = {
              note,
              posX: startX,
              posY: startY,
              size: beamNoteSize,
            }; // Store size for moveNote

            // ‰∫àÊ∏¨Á∑ö„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å®ÁßªÂãïÂá¶ÁêÜ
            setTimeout(() => {
              noteAria.style.opacity = "0";
              moveNote(noteObj, vx, vy);
              setTimeout(() => {
                noteAria.remove();
              }, 300);
            }, moveDelay);

            // ‰∫àÊ∏¨Á∑ö„ÇíÁÇπÊªÖ„Åï„Åõ„Çã
            let blinkCount = 0;
            const blinkInterval = setInterval(() => {
              noteAria.style.opacity = blinkCount % 2 === 0 ? "0.5" : "0.2";
              blinkCount++;
              if (blinkCount >= 6) clearInterval(blinkInterval);
            }, 200);
          }
        }
      }

      function checkCollision(note) {
        const playerRect = player.getBoundingClientRect();
        const noteRect = note.getBoundingClientRect();

        return (
          playerRect.left < noteRect.right &&
          playerRect.right > noteRect.left &&
          playerRect.top < noteRect.bottom &&
          playerRect.bottom > noteRect.top
        );
      }

      document.body.addEventListener("keydown", (event) => {
        const key = event.key === " " ? "space" : event.key.toLowerCase(); // „Çπ„Éö„Éº„Çπ„Çí "space" „Å´Â§âÊèõ
        keys[key] = true;
        console.log(`„Ç≠„ÉºÊäº‰∏ã: ${event.key}`); // „Éá„Éê„ÉÉ„Ç∞Áî®
      });

      document.body.addEventListener("keyup", (event) => {
        const key = event.key === " " ? "space" : event.key.toLowerCase(); // „Çπ„Éö„Éº„Çπ„Çí "space" „Å´Â§âÊèõ
        keys[key] = false;
        console.log(`„Ç≠„ÉºËß£Êîæ: ${event.key}`); // „Éá„Éê„ÉÉ„Ç∞Áî®
      });

      document.body.addEventListener("keydown", (event) => {
        const key = event.key === " " ? "space" : event.key.toLowerCase();
        // „Ç≠„Éº„ÅåÊó¢„Å´Êäº„Åï„Çå„Å¶„ÅÑ„ÇãÔºàtrueÔºâÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
        if (isTriggerPush) {
          return;
        } else {
          isTriggerPush = true;
          selectkeys[key] = true;
        }
        console.log(`„Ç≠„ÉºÊäº‰∏ã: ${event.key}`); // „Éá„Éê„ÉÉ„Ç∞Áî®
      });

      document.body.addEventListener("keyup", (event) => {
        const key = event.key === " " ? "space" : event.key.toLowerCase();
        isTriggerPush = false;
        selectkeys[key] = false;
        console.log(`„Ç≠„ÉºËß£Êîæ: ${event.key}`); // „Éá„Éê„ÉÉ„Ç∞Áî®
      });

      // „Ç≤„Éº„É†„Éë„ÉÉ„ÉâÊé•Á∂öÊôÇ„ÅÆ„Ç§„Éô„É≥„Éà
      window.addEventListener("gamepadconnected", (event) => {
        gamepadIndex = event.gamepad.index;
        console.log(`„Ç≤„Éº„É†„Éë„ÉÉ„ÉâÊé•Á∂ö: „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ ${gamepadIndex}`);
      });

      // „Ç≤„Éº„É†„Éë„ÉÉ„ÉâÂàáÊñ≠ÊôÇ„ÅÆ„Ç§„Éô„É≥„Éà
      window.addEventListener("gamepaddisconnected", (event) => {
        if (gamepadIndex === event.gamepad.index) {
          gamepadIndex = null;
          console.log(`„Ç≤„Éº„É†„Éë„ÉÉ„ÉâÂàáÊñ≠: „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ ${event.gamepad.index}`);
        }
      });

      // „Éá„ÉÉ„Éâ„Çæ„Éº„É≥Ë®≠ÂÆöÔºà„Ç¢„Éä„É≠„Ç∞„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„ÅÆÂæÆÂ∞è„Å™ÂÖ•Âäõ„ÇíÁÑ°Ë¶ñÔºâ
      const deadZone = 0.2;

      updateSceneDisplay();
      updateScale();
    </script>
  </body>
</html>
